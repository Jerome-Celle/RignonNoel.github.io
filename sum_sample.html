<html>

    <head>
        <meta charset='utf-8'>

        <style>
            #chart{
                width: 1000px;
                background-color: lightgray;
                margin: auto;
            }
        </style>

        <script type="text/javascript">
            function make_grouped_sample() {
                // Init the sample
                var sample = [];

                // Get all generated sample add to the group
                var form = document.getElementById('generated_sample');
                var generated_samples = form.getElementsByClassName('textarea_sample');

                // For each sample
                for (var index_sample=0;index_sample<generated_samples.length;index_sample++) {
                    var lines = generated_samples[index_sample].value.split('\n');

                    // For each line in the sample
                    for(var index_line = 0;index_line < lines.length;index_line++){
                        if (lines[index_line] != "") {
                            var attributs = lines[index_line].split(';');

                            // We push the sample to the begin time
                            var time = document.getElementById('time_' + index_sample).value;
                            attributs[0] = parseFloat(attributs[0]) + parseFloat(time);
                            var time_not_exist = true;

                            // We check if this time of sampling already exist
                            for (var index = 0; index < sample.length; index++) {
                                if (sample[index][0] == attributs[0]) {
                                    time_not_exist = false;
                                    var sum_value = parseFloat(sample[index][1]) + parseFloat(attributs[1]);

                                    // We can't have more than 100 percent
                                    if (sum_value > 100) {
                                        sum_value = 100;
                                    }
                                    sample[index][1] = sum_value;
                                }
                            }
                            // If time doesn't exist we create a new line of sample
                            if (time_not_exist) {
                                sample.push([attributs[0], attributs[1]]);
                            }
                        }
                    }
                }

                // We check if all line of the sample exist also we create line with value 0
                var first_time = parseFloat(sample[0][0]);
                var second_time = parseFloat(sample[1][0]);
                var period = second_time - first_time;

                // We sort sample to find the max of the group sample
                sample.sort(function(a,b) {
                    return a[0] - b[0];
                });
                var max_time = sample[sample.length-1][0];

                var time = 0;
                while(time < max_time){
                    var time_not_exist = true;
                    for (var index = 0; index < sample.length; index++) {
                        if(sample[index][0] == time){
                            time_not_exist = false;
                        }
                    }
                    if(time_not_exist){
                        sample.push([time, '0'])
                    }
                    time += period;
                }

                // We sort sample to have a correct sample
                sample.sort(function(a,b) {
                    return a[0] - b[0];
                });
                print_sample(sample)
            }

            function print_sample(sample){
                /*
                 * Display the sample string in the page to allow copy/paste
                 */
                var sample_text = "";
                sample.forEach(function(point){
                    sample_text += point[0]+ ";" + point[1] + "\r\n";
                });
                document.getElementById('sample_data').innerHTML = sample_text;
            }

            function add_generated_sample(){
                var form = document.getElementById('generated_sample');

                var index = form.getElementsByClassName('generated_sample_added').length;

                var new_div = document.createElement("div");
                new_div.setAttribute('class', 'generated_sample_added');
                var title = document.createElement("h3");
                title.innerHTML = "Generated sample " + index;
                var new_div_margin = document.createElement("div");
                new_div_margin.style = "margin-left:50px;";
                var p_textarea = document.createElement("p");
                var label_textarea = document.createElement("label");
                label_textarea.innerHTML = "Your generated sample :";
                label_textarea.setAttribute('for', "sample_"+index);
                var textarea = document.createElement("textarea");
                textarea.id = "sample_" + index;
                textarea.setAttribute('class', 'textarea_sample');
                textarea.style = "width: 100%; height: 200px;";
                var p_input = document.createElement("p");
                var label_input = document.createElement("label");
                label_input.innerHTML = "Begin time of this sample :";
                label_input.setAttribute('for', "time_"+index);
                var input = document.createElement("input");
                input.id = "time_" + index;
                input.type = "number";
                input.setAttribute('min', 0);
                input.defaultValue = 0;
                var hr = document.createElement("hr");

                new_div.appendChild(title);
                new_div.appendChild(new_div_margin);
                new_div_margin.appendChild(p_textarea);
                new_div_margin.appendChild(p_input);
                p_textarea.appendChild(label_textarea);
                p_textarea.appendChild(textarea);
                p_input.appendChild(label_input);
                p_input.appendChild(input);
                form.appendChild(new_div);
                /***
                 * <div class="generated_sample_added">
                 <h3>Generated sample 1</h3>
                 <div style="margin-left:50px;">
                 <p>
                 <label for="sample_1">Your generated sample:</label>
                 <textarea id="sample_1" style="width: 100%; height: 200px;"></textarea>
                 </p>
                 <p>
                 <label for="time_1">Time to begin the sample:</label>
                 <input type="text" id="time_1" />
                 </p>
                 </div>
                 <hr>
                 </div>
                 */
            }
        </script>

    </head>

    <body>
        <h1 style="text-align: center;">Group of samples</h1>

        <hr>

        <h2>
            1 - Insert your generated sample :
            <button onclick="add_generated_sample()">Add an other generated sample</button>
        </h2>

        <p style="color: red;">
            <strong>
                Warning:
            </strong>
            All your sample need to have the same frequency. You can't group a sample at 200Hz and a sample at 300Hz
        </p>

        <form id="generated_sample">
        </form>

        <h2>2 - Group your samples : <button onclick="make_grouped_sample()">Generate</button></h2>

        <hr>

        <h2>3 - Get your grouped samples : </h2>

        <textarea readonly id="sample_data" style="width: 100%; height: 200px;">You don't have any grouped sample for the moment</textarea>
    </body>
</html>
